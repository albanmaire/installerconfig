
# Copyright (c) 2023, Alban MAIRE (al) <a.maire@totore.net>
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
#   1. Redistributions of source code must retain the above copyright notice, this
#      list of conditions and the following disclaimer.
#
#   2. Redistributions in binary form must reproduce the above copyright notice,
#      this list of conditions and the following disclaimer in the documentation
#      and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


# Preamble
# ----------------------------------------------------------------

# Partition the disk(s) according to your needs
#PARTITIONS=''

# Choose the system components to be installed
DISTRIBUTION='kernel.txz base.txz'


# Setup script
# ----------------------------------------------------------------
#!/usr/bin/env sh

# Set up your network configuration
HOSTNAME=''
INTERFACE=''
INET=''
NETMASK=''
DEFAULTROUTER=''

# Activate services at startup
LOCAL_UNBOUND=''
SSHD=''
MOUSED=''
NTPDATE=''
NTPD=''
POWERD=''
DUMPDEV=''

# Define rc.conf(5) behavior
RC_CONF_DIR=''


# Default network configuration
_HOSTNAME=''
_INTERFACE=''
_INET=''
_NETMASK=''
_DEFAULTROUTER=''

# Default services activated at startup
_LOCAL_UNBOUND='NO'
_SSHD='YES'
_MOUSED='NO'
_NTPDATE='NO'
_NTPD='NO'
_POWERD='NO'
_DUMPDEV='AUTO'

# Default rc.conf(5) behaviour
_RC_CONF_DIR='NO'
_RC_CONF_FILE='/etc/rc.conf'
_RC_CONF_CUSTOM='/etc/rc.conf.d'


# Networking
network() {
	local RC_CONF_FILE
	local ITEMS ITEM _ITEM

	[ ! "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_FILE"

	ITEMS='
		HOSTNAME
		NETWORK
		ROUTING
	'

	for ITEM in $ITEMS; do
		_ITEM=$(echo $ITEM | tr '[:upper:]' '[:lower:]')
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/$_ITEM"

		case $ITEM in
			HOSTNAME)
				sysrc -f $RC_CONF_FILE hostname="${HOSTNAME:-$_HOSTNAME}"
				;;

			NETWORK)
				sysrc -f $RC_CONF_FILE ifconfig_${INTERFACE:-$_INTERFACE}="inet ${INET:-$_INET} netmask ${NETMASK:-$_NETMASK}"
				;;

			ROUTING)
				sysrc -f $RC_CONF_FILE defaultrouter="${DEFAULTROUTER:-$_DEFAULTROUTER}"
				;;
		esac
	done
}

# Services
services() {
	local RC_CONF_FILE
	local ITEMS ITEM _ITEM
	local VALUE _VALUE

	[ ! "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_FILE"

	ITEMS='
		LOCAL_UNBOUND
		SSHD
		MOUSED
		NTPDATE
		NTPD
		POWERD
	'

	for ITEM in $ITEMS; do
		eval VALUE="\$$ITEM"
		eval _VALUE="\$_$ITEM"

		_ITEM=$(echo $ITEM | tr '[:upper:]' '[:lower:]')
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/$_ITEM"
		[ "${VALUE:-$_VALUE}" = 'YES' ] && sysrc -f $RC_CONF_FILE ${_ITEM}_enable="YES"
	done

	if [ "${DUMPDEV:-$_DUMPDEV}" = 'AUTO' ]; then
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/dumpon"
		sysrc -f $RC_CONF_FILE dumpdev="AUTO"
	fi
}
