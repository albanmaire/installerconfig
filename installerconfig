
# Copyright (c) 2023, Alban MAIRE (al) <a.maire@totore.net>
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
#   1. Redistributions of source code must retain the above copyright notice, this
#      list of conditions and the following disclaimer.
#
#   2. Redistributions in binary form must reproduce the above copyright notice,
#      this list of conditions and the following disclaimer in the documentation
#      and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
# (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
# LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
# ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


# Preamble
# ----------------------------------------------------------------

# Partition the disk(s) according to your needs
#PARTITIONS=''

# Choose the system components to be installed
DISTRIBUTION='kernel.txz base.txz'


# Setup script
# ----------------------------------------------------------------
#!/usr/bin/env sh

# Set up your network configuration
HOSTNAME=''
INTERFACE=''
INET=''
NETMASK=''
DEFAULTROUTER=''

# Activate services at startup
LOCAL_UNBOUND=''
SSHD=''
MOUSED=''
NTPDATE=''
NTPD=''
POWERD=''
DUMPDEV=''

# Declare hardening options
HIDE_UIDS=''
HIDE_GIDS=''
HIDE_JAIL=''
READ_MSGBUF=''
PROC_DEBUG=''
RANDOM_PID=''
CLEAR_TMP=''
DISABLE_SYSLOGD=''
DISABLE_SENDMAIL=''
SECURE_CONSOLE=''
DISABLE_DDTRACE=''

# Define rc.conf(5) behavior
RC_CONF_DIR=''


# Default network configuration
_HOSTNAME=''
_INTERFACE=''
_INET=''
_NETMASK=''
_DEFAULTROUTER=''

# Default services activated at startup
_LOCAL_UNBOUND='NO'
_SSHD='YES'
_MOUSED='NO'
_NTPDATE='NO'
_NTPD='NO'
_POWERD='NO'
_DUMPDEV='AUTO'

# Default hardening options
_HIDE_UIDS='NO'
_HIDE_GIDS='NO'
_HIDE_JAIL='NO'
_READ_MSGBUF='NO'
_PROC_DEBUG='NO'
_RANDOM_PID='NO'
_CLEAR_TMP='NO'
_DISABLE_SYSLOGD='NO'
_DISABLE_SENDMAIL='NO'
_SECURE_CONSOLE='NO'
_DISABLE_DDTRACE='NO'

# Default rc.conf(5) behaviour
_RC_CONF_DIR='NO'
_RC_CONF_FILE='/etc/rc.conf'
_RC_CONF_CUSTOM='/etc/rc.conf.d'


# Networking
network() {
	local RC_CONF_FILE
	local ITEMS ITEM _ITEM

	[ ! "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_FILE"

	ITEMS='
		HOSTNAME
		NETWORK
		ROUTING
	'

	for ITEM in $ITEMS; do
		_ITEM=$(echo $ITEM | tr '[:upper:]' '[:lower:]')
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/$_ITEM"

		case $ITEM in
			HOSTNAME)
				sysrc -f $RC_CONF_FILE hostname="${HOSTNAME:-$_HOSTNAME}"
				;;

			NETWORK)
				sysrc -f $RC_CONF_FILE ifconfig_${INTERFACE:-$_INTERFACE}="inet ${INET:-$_INET} netmask ${NETMASK:-$_NETMASK}"
				;;

			ROUTING)
				sysrc -f $RC_CONF_FILE defaultrouter="${DEFAULTROUTER:-$_DEFAULTROUTER}"
				;;
		esac
	done
}

# Services
services() {
	local RC_CONF_FILE
	local ITEMS ITEM _ITEM
	local VALUE _VALUE

	[ ! "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_FILE"

	ITEMS='
		LOCAL_UNBOUND
		SSHD
		MOUSED
		NTPDATE
		NTPD
		POWERD
	'

	for ITEM in $ITEMS; do
		eval VALUE="\$$ITEM"
		eval _VALUE="\$_$ITEM"

		_ITEM=$(echo $ITEM | tr '[:upper:]' '[:lower:]')
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/$_ITEM"
		[ "${VALUE:-$_VALUE}" = 'YES' ] && sysrc -f $RC_CONF_FILE ${_ITEM}_enable="YES"
	done

	if [ "${DUMPDEV:-$_DUMPDEV}" = 'AUTO' ]; then
		[ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_CUSTOM/dumpon"
		sysrc -f $RC_CONF_FILE dumpdev="AUTO"
	fi
}

# Hardening
hardening() {
	local RC_CONF_FILE
	local ITEMS ITEM
	local VALUE _VALUE

	[ ! "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ] && RC_CONF_FILE="$_RC_CONF_FILE"

	ITEMS='
		HIDE_UIDS
		HIDE_GIDS
		HIDE_JAIL
		READ_MSGBUF
		PROC_DEBUG
		RANDOM_PID
		CLEAR_TMP
		DISABLE_SYSLOGD
		DISABLE_SENDMAIL
		SECURE_CONSOLE
		DISABLE_DDTRACE
	'

	for ITEM in $ITEMS; do
		eval VALUE="\$$ITEM"
		eval _VALUE="\$_$ITEM"

		if [ "${RC_CONF_DIR:-$_RC_CONF_DIR}" = 'YES' ]; then
			case $ITEM in
				CLEAR_TMP)
					RC_CONF_FILE="$_RC_CONF_CUSTOM/cleartmp"
					;;

				DISABLE_SYSLOGD)
					RC_CONF_FILE="$_RC_CONF_CUSTOM/syslogd"
					;;

				DISABLE_SENDMAIL)
					RC_CONF_FILE="$_RC_CONF_CUSTOM/sendmail"
					;;
			esac
		fi

		if [ "${VALUE:-$_VALUE}" = 'YES' ]; then
			case $ITEM in
				HIDE_UIDS)
					echo 'security.bsd.see_other_uids="0"' >> /etc/sysctl.conf
					;;

				HIDE_GIDS)
					echo 'security.bsd.see_other_gids="0"' >> /etc/sysctl.conf
					;;

				HIDE_JAIL)
					echo 'security.bsd.see_jail_proc="0"' >> /etc/sysctl.conf
					;;

				READ_MSGBUF)
					echo 'security.bsd.unprivileged_read_msgbuf="0"' >> /etc/sysctl.conf
					;;

				PROC_DEBUG)
					echo 'security.bsd.unprivileged_proc_debug="0"' >> /etc/sysctl.conf
					;;

				RANDOM_PID)
					echo 'kern.randompid="1"' >> /etc/sysctl.conf
					;;

				CLEAR_TMP)
					sysrc -f $RC_CONF_FILE clear_tmp_enable="YES"
					;;

				DISABLE_SYSLOGD)
					sysrc -f $RC_CONF_FILE syslogd_flags="-ss"
					;;

				DISABLE_SENDMAIL)
					sysrc -f $RC_CONF_FILE sendmail_enable="NONE"
					;;

				SECURE_CONSOLE)
					sed -i.bak 's/unknown	off secure/unknown	off insecure/g' /etc/ttys
					;;

				DISABLE_DDTRACE)
					echo 'security.bsd.allow_destructive_dtrace="0"' >> /etc/sysctl.conf
					;;
			esac
		fi
	done
}
